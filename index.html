<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Attendance System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.16/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
</head>
<body class="bg-gray-100 py-8">
  <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold mb-4">Face Attendance System</h1>
    <div class="flex justify-center mb-4">
      <video id="video" width="640" height="480" autoplay muted></video>
      <canvas id="canvas" width="640" height="480" class="hidden"></canvas>
    </div>
    <div class="text-center mb-4">
      <button id="scanButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        <svg class="w-6 h-6 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        Scan Face
      </button>
    </div>
    <div id="result" class="text-center"></div>
    <div id="loginHistory" class="mt-4"></div>

    <script>
      // Khởi tạo camera và canvas
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          video.play();
        })
        .catch(error => {
          console.error('Error initializing camera:', error);
        });

      // Sự kiện khi bấm nút "Scan Face"
      const scanButton = document.getElementById('scanButton');
      const resultDiv = document.getElementById('result');
      const loginHistoryDiv = document.getElementById('loginHistory');

      scanButton.addEventListener('click', async () => {
        // Nhận diện khuôn mặt
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const detections = await faceApi.detectSingleFace(canvas, new faceApi.TinyFaceDetectorOptions());

        if (detections) {
          // Lưu lịch sử đăng nhập
          const loginTime = new Date().toLocaleString();
          const loginHistory = JSON.parse(localStorage.getItem('loginHistory')) || [];
          loginHistory.push({ time: loginTime, image: canvas.toDataURL() });
          localStorage.setItem('loginHistory', JSON.stringify(loginHistory));

          // Hiển thị thông báo đăng nhập thành công
          resultDiv.innerHTML = `
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
              <strong class="font-bold">Đăng nhập thành công!</strong>
              <span class="block sm:inline">Chào mừng ${/* Tên người dùng được nhận diện */}.</span>
            </div>
          `;

          // Hiển thị lịch sử đăng nhập
          showLoginHistory();
        } else {
          // Hiển thị thông báo đăng nhập thất bại
          resultDiv.innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
              <strong class="font-bold">Đăng nhập thất bại!</strong>
              <span class="block sm:inline">Không thể nhận diện khuôn mặt. Vui lòng thử lại.</span>
            </div>
          `;
        }
      });

      // Hiển thị lịch sử đăng nhập
      function showLoginHistory() {
        const loginHistory = JSON.parse(localStorage.getItem('loginHistory')) || [];
        let historyHTML = '';

        loginHistory.forEach((entry, index) => {
          historyHTML += `
            <div class="flex items-center mb-2">
              <img src="${entry.image}" alt="Login ${index}" class="w-12 h-12 rounded-full mr-2" />
              <span>${entry.time}</span>
            </div>
          `;
        });

        loginHistoryDiv.innerHTML = `
          <h3 class="text-xl font-bold mb-2">Lịch sử đăng nhập</h3>
          ${historyHTML}
        `;
      }

      // Tải thư viện face-api.js
      Promise.all([
        faceApi.nets.tinyFaceDetector.loadFromUri('/models'),
        faceApi.nets.faceLandmark68Net.loadFromUri('/models'),
        faceApi.nets.faceRecognitionNet.loadFromUri('/models'),
        faceApi.nets.faceExpressionNet.loadFromUri('/models')
      ]).then(showModal);
    </script>
  </div>
</body>
</html>
